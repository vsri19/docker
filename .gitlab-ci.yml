image: docker:latest

services:
  - docker:dind

# DOCKER_DRIVER: Requires when sharing folder with running containers
# IMAGE_NAME   : Name of the branche or tag name
variables:
  DOCKER_DRIVER: overlay
  IMAGE_NAME: $CI_COMMIT_REF_SLUG

# Stages: sequential stages for this project to execute one after another
stages:
  - build
  - test
  - deploy

# Bring command shortcuts like 'docker_build_push' made in file 'prepare'
before_script:
- source prepare

# Build and push image using oneshot command with branch name as image name
# (does not used long conventional coding like 'docker build -t test .' ...)
build_image:
  stage: build
  script:
    - docker_build_push $IMAGE_NAME
    - docker_tag_push $IMAGE_NAME compiled
  only:
    - tags
    - branch

# Test image by executing its code (docker pull followed with docker run)
test_image:
  stage: test
  script:
    - docker_test_image $IMAGE_NAME compiled
  only:
    - tags
    - branch

# Tag image as latest on branch name when previous test is passed
deploy_image:
  stage: deploy
  script:
    - docker_tagg_image $IMAGE_NAME compiled latest
  when: manual
  only:
    - tags
    - master
